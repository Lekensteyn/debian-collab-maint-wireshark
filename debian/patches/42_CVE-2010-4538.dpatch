#! /bin/sh /usr/share/dpatch/dpatch-run
## 42_CVE-2010-4538.dpatch by  <balint@balintreczey.hu>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Fix for CVE-2010-4538, backported from 
## DP: http://anonsvn.wireshark.org/viewvc?view=rev&revision=35318

@DPATCH@
diff -Naur lenny~/epan/tvbuff.c lenny/epan/tvbuff.c
--- ./plugins/enttec/packet-enttec.c.orig	2008-07-10 19:37:28.000000000 +0200
+++ ./plugins/enttec/packet-enttec.c	2011-01-05 23:06:19.000000000 +0100
@@ -203,8 +203,8 @@
 		"%3u: %s"
 	};
 
-	static guint8 dmx_data[512];
-	static guint16 dmx_data_offset[513]; /* 1 extra for last offset */
+	guint8 *dmx_data = ep_alloc(512 * sizeof(guint8));
+	guint16 *dmx_data_offset = ep_alloc(513 * sizeof(guint16)); /* 1 extra for last offset */
 	static char string[255];
 
 	proto_tree *hi,*si;
@@ -235,10 +235,10 @@
 		length = 512;
 
 	if (type == ENTTEC_DATA_TYPE_RLE) {
-		/* uncompres the DMX data */
+		/* uncompress the DMX data */
 		ui = 0;
 		ci = 0;
-		while (ci < length) {
+		while (ci < length && ui < 512) {
 			v = tvb_get_guint8(tvb, offset+ci);
 			if (v == 0xFE) {
 				ci++;
@@ -246,7 +246,7 @@
 				ci++;
 				v = tvb_get_guint8(tvb, offset+ci);
 				ci++;
-				for (i=0;i < count;i++) {
+				for (i=0;i < count && ui < 512;i++) {
 					dmx_data[ui] = v;
 					dmx_data_offset[ui] = ci-3;
 					ui++;
