#! /bin/sh /usr/share/dpatch/dpatch-run
## 43_CVE-2011-0538.dpatch by  <balint@balintreczey.hu>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: pcapng file format sanity tests backported from wireshark trunk
## DP: (up to r36057)

@DPATCH@
diff --git a/tshark.c b/tshark.c
diff --git a/tshark.c b/tshark.c
index 3a0d0fd..a9edb14 100644
--- a/tshark.c
+++ b/tshark.c
@@ -2185,7 +2185,7 @@ load_cap_file(capture_file *cf, char *save_file, int out_file_type,
   int          snapshot_length;
   wtap_dumper *pdh;
   int          err;
-  gchar        *err_info;
+  gchar        *err_info = NULL;
   gint64       data_offset;
   char         *save_file_string = NULL;
 
diff --git a/wiretap/pcapng.c b/wiretap/pcapng.c
index aeb4a54..9c00607 100644
--- a/wiretap/pcapng.c
+++ b/wiretap/pcapng.c
@@ -41,7 +41,7 @@
 #include "buffer.h"
 
 
-#if 0
+#if 1
 #define pcapng_debug0(str) g_warning(str)
 #define pcapng_debug1(str,p1) g_warning(str,p1)
 #define pcapng_debug2(str,p1,p2) g_warning(str,p1,p2)
@@ -623,6 +623,27 @@ pcapng_read_packet_block(FILE_T fh, pcapng_block_header_t *bh, pcapng_t *pn, wta
 		wblock->data.packet.packet_len	= epb.packet_len;
 	}
 
+	if (wblock->data.packet.cap_len > wblock->data.packet.packet_len) {
+		*err = WTAP_ERR_BAD_RECORD;
+		*err_info = g_strdup_printf("pcapng_read_packet_block: cap_len %u is larger than packet_len %u.",
+		    wblock->data.packet.cap_len, wblock->data.packet.packet_len);
+		return 0;
+	}
+	if (wblock->data.packet.cap_len > WTAP_MAX_PACKET_SIZE) {
+		*err = WTAP_ERR_BAD_RECORD;
+		*err_info = g_strdup_printf("pcapng_read_packet_block: cap_len %u is larger than WTAP_MAX_PACKET_SIZE %u.",
+		    wblock->data.packet.cap_len, WTAP_MAX_PACKET_SIZE);
+		return 0;
+	}
+	pcapng_debug2("pcapng_read_packet_block: packet data: packet_len %u captured_len %u",
+	              wblock->data.packet.packet_len,
+	              wblock->data.packet.cap_len);
+	if (wblock->data.packet.packet_len > WTAP_MAX_PACKET_SIZE) {
+		*err = WTAP_ERR_BAD_RECORD;
+		*err_info = g_strdup_printf("pcapng_read_packet_block: packet_len %u is larger than WTAP_MAX_PACKET_SIZE %u.",
+		    wblock->data.packet.packet_len, WTAP_MAX_PACKET_SIZE);
+		return 0;
+	}
 	/*pcapng_debug2("pcapng_read_packet_block: packet data: packet_len %u captured_len %u",
 		wblock->data.packet.packet_len, wblock->data.packet.cap_len);*/
 
