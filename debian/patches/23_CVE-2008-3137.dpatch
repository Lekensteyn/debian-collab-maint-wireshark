#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2008-3137
##
## All lines beginning with `## DP:' are a description of the patch.

@DPATCH@
diff -aur wireshark-0.99.4.orig/epan/dissectors/packet-gsm_sms.c wireshark-0.99.4/epan/dissectors/packet-gsm_sms.c
--- wireshark-0.99.4.orig/epan/dissectors/packet-gsm_sms.c	2006-10-31 18:59:08.000000000 +0100
+++ wireshark-0.99.4/epan/dissectors/packet-gsm_sms.c	2008-11-29 11:47:57.000000000 +0100
@@ -215,6 +215,7 @@
 	oct); \
 }
 
+#define MAX_ADDR_SIZE 20
 static void
 dis_field_addr(tvbuff_t *tvb, proto_tree *tree, guint32 *offset_p, const gchar *title)
 {
@@ -227,7 +228,7 @@
     guint32		numdigocts;
     guint32		length;
     guint32		i, j;
-    char                addrbuf[20];
+    char                addrbuf[MAX_ADDR_SIZE+1];
 
     offset = *offset_p;
 
@@ -319,7 +320,7 @@
     switch ((oct & 0x70) >> 4)
     {
     case 0x05: /* "Alphanumeric (coded according to 3GPP TS 23.038 GSM 7-bit default alphabet)" */
-	i = gsm_sms_char_7bit_unpack(0, numdigocts, sizeof(addrbuf), tvb_get_ptr(tvb, offset, numdigocts), addrbuf);
+	i = gsm_sms_char_7bit_unpack(0, numdigocts, MAX_ADDR_SIZE, tvb_get_ptr(tvb, offset, numdigocts), addrbuf);
 	addrbuf[i] = '\0';
 	gsm_sms_char_ascii_decode(bigbuf, addrbuf, i);
 	break;
@@ -1778,6 +1779,7 @@
 
 /* 9.2.3.24 */
 #define NUM_FILL_BITS_MASKS 6
+#define SMS_MAX_MESSAGE_SIZE 160
 static void
 dis_field_ud(tvbuff_t *tvb, proto_tree *tree, guint32 offset, guint32 length, gboolean udhi, guint8 udl,
     gboolean seven_bit, gboolean eight_bit, gboolean ucs2, gboolean compressed)
@@ -1792,7 +1794,7 @@
     guint	fill_bits;
     guint32	out_len;
     char	*ustr;
-    char        messagebuf[160];
+    char        messagebuf[SMS_MAX_MESSAGE_SIZE+1];
 
     fill_bits = 0;
 
@@ -1861,7 +1863,7 @@
 		if (seven_bit)
 		{
 		    out_len =
-			gsm_sms_char_7bit_unpack(fill_bits, length, sizeof(messagebuf),
+			gsm_sms_char_7bit_unpack(fill_bits, length, SMS_MAX_MESSAGE_SIZE,
 		    tvb_get_ptr(tvb, offset, length), messagebuf);
 		    messagebuf[out_len] = '\0';
 		    gsm_sms_char_ascii_decode(bigbuf, messagebuf, out_len);
Only in wireshark-0.99.4/epan/dissectors: packet-gsm_sms.c~
